<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GalChat - AI 聊天助手</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container { height: calc(100vh - 240px); }
        .message-bubble { max-width: 80%; }
        .user-message { background-color: #3b82f6; color: white; border-radius: 18px 18px 2px 18px; }
        .other-message { background-color: #f3f4f6; color: #1f2937; border-radius: 18px 18px 18px 2px; }
        .option-btn { transition: all 0.2s; }
        .option-btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm p-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">GalChat 聊天室</h1>
            <p class="text-xs text-gray-500">实时读取聊天记录并给予回复建议</p>
        </div>
        <div class="flex items-center gap-2">
            <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500" title="未连接"></div>
        </div>
    </header>

    <!-- Chat History -->
    <main id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-4 chat-container">
        <!-- 消息将在此动态生成 -->
    </main>

    <!-- Options Area -->
    <div class="px-4 py-1 border-t bg-white">
        <div class="flex justify-between items-center mb-1">
            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">回复建议</span>
            <button id="refreshOptions" class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs hover:bg-blue-600 transition-colors">生成建议</button>
        </div>
        <div id="optionsContainer" class="flex flex-wrap gap-2 min-h-[40px]">
            <span class="text-gray-400 text-xs italic">点击“生成建议”按钮获取回复选项</span>
        </div>
    </div>

    <!-- Input Area -->
    <footer class="p-4 bg-white border-t">
        <div class="max-w-4xl mx-auto">
            <div class="flex gap-2">
                <textarea id="userInput" 
                    class="flex-1 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm"
                    placeholder="输入消息..." rows="2"></textarea>
                <button id="sendBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 disabled:bg-gray-400 self-stretch">
                    发送
                </button>
            </div>
        </div>
    </footer>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const optionsContainer = document.getElementById('optionsContainer');
        const statusDot = document.getElementById('statusDot');
        const refreshOptionsBtn = document.getElementById('refreshOptions');

        let socket = null;
        let myIP = null;
        let lastSender = null;

        function updateGenerateBtnState() {
            if (!lastSender) {
                refreshOptionsBtn.disabled = true;
                refreshOptionsBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                refreshOptionsBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                refreshOptionsBtn.title = "聊天记录为空，无法生成建议";
            } else if (lastSender === myIP) {
                refreshOptionsBtn.disabled = true;
                refreshOptionsBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                refreshOptionsBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                refreshOptionsBtn.title = "最后一条消息是你发送的，无需生成建议";
            } else {
                refreshOptionsBtn.disabled = false;
                refreshOptionsBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                refreshOptionsBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                refreshOptionsBtn.title = "";
            }
        }

        // 初始化按钮状态
        updateGenerateBtnState();

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws/chat`);

            socket.onopen = () => {
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                statusDot.title = '已连接';
                console.log('Connected to WebSocket');
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'init') {
                    myIP = data.your_ip;
                    console.log('Your IP:', myIP);
                    // 收到 IP 后，如果历史消息已经加载，可能需要刷新按钮状态
                    updateGenerateBtnState();
                    return;
                }
                
                if (data.type === 'message') {
                    addMessage(data.text, data.user, data.user === myIP);
                }
            };

            socket.onclose = () => {
                statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                statusDot.title = '连接已断开';
                console.log('WebSocket connection closed');
                setTimeout(connect, 3000); // 3秒后尝试重连
            };

            socket.onerror = (err) => {
                console.error('WebSocket error:', err);
            };
        }

        function addMessage(text, user, isMe) {
            lastSender = user;
            updateGenerateBtnState();

            const div = document.createElement('div');
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-xs text-gray-500 mb-1 px-1';
            nameSpan.innerText = user;
            
            const bubble = document.createElement('div');
            bubble.className = `${isMe ? 'user-message' : 'other-message'} message-bubble p-3 shadow-sm text-sm`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            
            div.appendChild(nameSpan);
            div.appendChild(bubble);
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function fetchOptions() {
            optionsContainer.innerHTML = '<span class="text-gray-400 text-xs italic">正在基于当前对话生成建议...</span>';
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        mode: 0
                    }) // 不传 input_str 和 current_user，后端自动处理
                });
                
                const result = await response.json();
                optionsContainer.innerHTML = '';
                
                if (result.status === 'success' && result.data.contents && result.data.contents.length > 0) {
                    result.data.contents.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-xs hover:bg-blue-50 shadow-sm flex items-center gap-1';
                        
                        // 添加内容文本
                        const contentSpan = document.createElement('span');
                        contentSpan.innerText = opt.content;
                        btn.appendChild(contentSpan);

                        // 添加情感标签
                        if (opt.emotion) {
                            const emotionTag = document.createElement('span');
                            emotionTag.className = 'bg-blue-100 text-blue-500 px-1.5 py-0.5 rounded text-[10px] font-bold';
                            emotionTag.innerText = opt.emotion;
                            btn.appendChild(emotionTag);
                        }

                        btn.onclick = () => {
                            userInput.value = opt.content;
                            userInput.focus();
                        };
                        optionsContainer.appendChild(btn);
                    });
                } else {
                    optionsContainer.innerHTML = '<span class="text-gray-400 text-xs italic">暂无建议，点击“生成建议”重试</span>';
                }
            } catch (err) {
                console.error(err);
                optionsContainer.innerHTML = '<span class="text-red-400 text-xs italic">获取建议失败</span>';
            }
        }

        function sendMessage(text) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    text: text
                }));
                return true;
            }
            return false;
        }

        sendBtn.onclick = () => {
            const text = userInput.value.trim();
            if (!text) return;
            
            if (sendMessage(text)) {
                userInput.value = '';
                // 移除自动刷新建议的逻辑
            } else {
                alert('未连接到服务器');
            }
        };

        refreshOptionsBtn.onclick = fetchOptions;

        // 快捷键支持
        userInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                if (e.ctrlKey) {
                    // Ctrl + Enter 发送
                    e.preventDefault();
                    sendBtn.click();
                } else if (!e.shiftKey) {
                    // 仅 Enter 也发送 (保持原逻辑)
                    e.preventDefault();
                    sendBtn.click();
                }
            }
        };

        // 初始连接
        connect();
    </script>
</body>
</html>
